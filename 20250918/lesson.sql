CREATE TABLE CLIENTES (
  id    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  nome  VARCHAR2(100) NOT NULL,
  email VARCHAR2(120) UNIQUE
);

-- CREATE
DROP TABLE PRODUTOS PURGE;
CREATE TABLE PRODUTOS (
  id     NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  nome   VARCHAR2(100) NOT NULL,
  preco  NUMBER(10,2)  NOT NULL CHECK (preco >= 0),
  tipo   VARCHAR2(50) NOT NULL
);

-- Inserindo alguns produtos
INSERT ALL
  INTO PRODUTOS (nome, preco, tipo) VALUES ('Notebook X', 3000, 'Notebook')
  INTO PRODUTOS (nome, preco, tipo) VALUES ('Notebook Y', 3500, 'Notebook')
  INTO PRODUTOS (nome, preco, tipo) VALUES ('Celular Z', 2000, 'Celular')
SELECT 1 FROM dual;

CREATE TABLE PEDIDOS (
  id         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  cliente_id NUMBER NOT NULL,
  produto_id NUMBER NOT NULL,
  status     VARCHAR2(20) NOT NULL CHECK (status IN ('ABERTO','FINALIZADO','CANCELADO'))
);

-- Inserindo pedidos de teste
INSERT ALL
  INTO PEDIDOS (cliente_id, produto_id, status) VALUES (1, 1, 'ABERTO')
  INTO PEDIDOS (cliente_id, produto_id, status) VALUES (2, 2, 'CANCELADO')
  INTO PEDIDOS (cliente_id, produto_id, status) VALUES (3, 3, 'FINALIZADO')
  INTO PEDIDOS (cliente_id, produto_id, status) VALUES (1, 2, 'CANCELADO')
SELECT 1 FROM dual;

CREATE TABLE CLIENTES_STG (
  nome  VARCHAR2(100) NOT NULL,
  email VARCHAR2(120) NOT NULL
);

INSERT INTO CLIENTES_STG VALUES ('Victor', 'victor@email.com');
INSERT INTO CLIENTES(nome, email) VALUES('Victor ', 'jonhdoe@email.com');


MERGE INTO CLIENTES cl USING CLIENTES_STG cstg ON (cl.email = cstg.email)
            WHEN MATCHED THEN   
                UPDATE SET cl.nome = CONCAT(cl.nome, ' Atualizado')

            WHEN NOT MATCHED THEN
                INSERT INTO CLIENTES (nome, email) VALUES('Afonso', 'afonso@email.com');


SELECT email, nome FROM CLIENTES;
SELECT email, nome FROM CLIENTES_STG;